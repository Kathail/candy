<!doctype html>
<html lang="en" class="h-full">
    <head>
        <meta charset="utf-8" />
        <title>{% block title %}Candy Route Planner{% endblock %}</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!-- PWA Meta Tags -->
        <meta name="theme-color" content="#2563eb" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="apple-mobile-web-app-title" content="Candy Route" />
        <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" />
        <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}" />
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            bg: "#0b1220",
                            panel: "#1e293b",
                            panel2: "#243042",
                            border: "#2c3a4f",
                            muted: "#94a3b8",
                            good: "#22c55e",
                            warn: "#facc15",
                            danger: "#ef4444",
                            brand: "#2563eb",
                        },
                        boxShadow: {
                            soft: "0 1px 0 rgba(255,255,255,0.03), 0 12px 30px rgba(0,0,0,0.35)",
                        },
                    },
                },
            };
        </script>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/app.css') }}"
        />
        <!-- HTMX for dynamic updates -->
        <script src="https://unpkg.com/htmx.org@1.9.10"></script>
        <!-- Alpine.js for interactivity -->
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
        ></script>
    </head>
    <body class="h-full bg-bg text-slate-200 antialiased">
        <div class="min-h-screen flex flex-col lg:flex-row">
            <!-- Mobile Header -->
            <header
                class="lg:hidden bg-[#0e1626] border-b border-border/50 sticky top-0 z-50"
            >
                <div class="flex items-center justify-between p-4">
                    <div>
                        <div class="font-semibold text-lg">
                            Candy Route Planner
                        </div>
                        <div class="text-xs text-muted">Daily Sales Tool</div>
                    </div>
                    <button
                        id="mobile-menu-btn"
                        class="p-2 rounded-lg hover:bg-panel/50 transition-colors"
                        aria-label="Toggle menu"
                    >
                        <svg
                            class="w-6 h-6"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"
                            />
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Sidebar / Mobile Menu -->
            <aside
                id="sidebar"
                class="fixed lg:static inset-0 z-40 lg:z-auto w-full lg:w-64 bg-[#0e1626] transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out lg:shrink-0"
            >
                <!-- Mobile overlay -->
                <div
                    id="sidebar-overlay"
                    class="lg:hidden fixed inset-0 bg-black/50 opacity-0 pointer-events-none transition-opacity duration-300"
                ></div>

                <!-- Sidebar content -->
                <div
                    class="relative h-full flex flex-col bg-[#0e1626] shadow-2xl lg:shadow-none"
                >
                    <!-- Close button (mobile only) -->
                    <div
                        class="lg:hidden flex items-center justify-between p-4 border-b border-border/50"
                    >
                        <div>
                            <div class="font-semibold text-lg">Menu</div>
                        </div>
                        <button
                            id="mobile-menu-close"
                            class="p-2 rounded-lg hover:bg-panel/50 transition-colors"
                            aria-label="Close menu"
                        >
                            <svg
                                class="w-6 h-6"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"
                                />
                            </svg>
                        </button>
                    </div>

                    <!-- Desktop header -->
                    <div class="hidden lg:block p-4 mb-2">
                        <div class="font-semibold text-lg">
                            Candy Route Planner
                        </div>
                        <div class="text-xs text-muted">Daily Sales Tool</div>
                    </div>

                    <!-- Navigation -->
                    <nav class="flex-1 overflow-y-auto p-4">
                        {% include "partials/nav.html" %}
                    </nav>

                    <!-- User info and logout -->
                    <div class="p-4 border-t border-border/50">
                        {% if current_user.is_authenticated %}
                            {% include "partials/user_menu.html" %}
                        {% else %}
                            <div class="text-xs text-muted">
                                <span class="block">Version 1.0</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-x-hidden pb-20 lg:pb-0">
                <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                    {% block content %}{% endblock %}
                </div>
            </main>
        </div>

        <!-- Global Loading Bar for HTMX -->
        <div id="global-loader"></div>

        <!-- Mobile Bottom Navigation -->
        {% if current_user.is_authenticated %}
        <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-[#0e1626] border-t border-border/50 z-50 safe-area-bottom">
            <div class="flex items-center justify-around py-2">
                <a href="/" class="flex flex-col items-center py-1 px-3 rounded-lg transition {% if request.path == '/' %}text-brand{% else %}text-muted hover:text-white{% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="text-xs mt-0.5">Home</span>
                </a>
                <a href="/route" class="flex flex-col items-center py-1 px-3 rounded-lg transition {% if request.path.startswith('/route') %}text-brand{% else %}text-muted hover:text-white{% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                    </svg>
                    <span class="text-xs mt-0.5">Route</span>
                </a>
                <a href="/leads" class="flex flex-col items-center py-1 px-3 rounded-lg transition {% if request.path.startswith('/leads') %}text-brand{% else %}text-muted hover:text-white{% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                    </svg>
                    <span class="text-xs mt-0.5">Leads</span>
                </a>
                <a href="/customers" class="flex flex-col items-center py-1 px-3 rounded-lg transition {% if request.path.startswith('/customers') %}text-brand{% else %}text-muted hover:text-white{% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    <span class="text-xs mt-0.5">Customers</span>
                </a>
                <a href="/balances" class="flex flex-col items-center py-1 px-3 rounded-lg transition {% if request.path.startswith('/balances') %}text-brand{% else %}text-muted hover:text-white{% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="text-xs mt-0.5">Balances</span>
                </a>
            </div>
        </nav>
        {% endif %}

        <!-- Offline Indicator -->
        {% include "partials/offline_indicator.html" %}

        <!-- Mobile Menu Script -->
        <script>
            (function () {
                const sidebar = document.getElementById("sidebar");
                const overlay = document.getElementById("sidebar-overlay");
                const menuBtn = document.getElementById("mobile-menu-btn");
                const closeBtn = document.getElementById("mobile-menu-close");

                function openMenu() {
                    sidebar.classList.remove("-translate-x-full");
                    overlay.classList.remove(
                        "pointer-events-none",
                        "opacity-0",
                    );
                    overlay.classList.add("pointer-events-auto", "opacity-100");
                    document.body.style.overflow = "hidden";
                }

                function closeMenu() {
                    sidebar.classList.add("-translate-x-full");
                    overlay.classList.add("pointer-events-none", "opacity-0");
                    overlay.classList.remove(
                        "pointer-events-auto",
                        "opacity-100",
                    );
                    document.body.style.overflow = "";
                }

                if (menuBtn) {
                    menuBtn.addEventListener("click", openMenu);
                }

                if (closeBtn) {
                    closeBtn.addEventListener("click", closeMenu);
                }

                if (overlay) {
                    overlay.addEventListener("click", closeMenu);
                }

                // Close menu when clicking nav links on mobile
                const navLinks = sidebar.querySelectorAll("a");
                navLinks.forEach((link) => {
                    link.addEventListener("click", () => {
                        if (window.innerWidth < 1024) {
                            closeMenu();
                        }
                    });
                });

                // Handle window resize
                let resizeTimer;
                window.addEventListener("resize", () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        if (window.innerWidth >= 1024) {
                            closeMenu();
                        }
                    }, 250);
                });
            })();
        </script>

        <!-- App JavaScript -->
        <script src="{{ url_for('static', filename='js/app.js') }}"></script>

        <!-- Offline Support -->
        <script src="{{ url_for('static', filename='js/offline.js') }}"></script>

        <!-- Service Worker Registration -->
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then((registration) => {
                            console.log('Service Worker registered:', registration.scope);
                        })
                        .catch((error) => {
                            console.log('Service Worker registration failed:', error);
                        });
                });
            }
        </script>
    </body>
</html>
