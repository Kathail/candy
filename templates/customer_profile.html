{% extends "base.html" %}
{% block title %}{{ customer.name }} - Customer Profile{% endblock %}
{% block content %}

<div class="max-w-4xl mx-auto">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="{{ request.referrer or url_for('customers') }}" class="text-brand hover:underline text-sm flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Back
        </a>
    </div>

    <!-- Header -->
    <div class="bg-panel rounded-xl shadow-soft p-4 md:p-6 mb-4">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-4">
            <div>
                <h1 class="text-xl md:text-2xl font-semibold">{{ customer.name }}</h1>
                <p class="text-muted text-sm">{{ customer.city or 'No city' }}</p>
                {% if customer.status == 'inactive' %}
                <span class="inline-block mt-2 text-xs bg-warn/20 text-warn px-2 py-1 rounded">Archived</span>
                {% elif customer.status == 'lead' %}
                <span class="inline-block mt-2 text-xs bg-brand/20 text-brand px-2 py-1 rounded">Lead</span>
                {% endif %}
            </div>
            <button
                onclick="openEditModal({{ customer.id }})"
                class="bg-brand hover:bg-blue-700 text-white text-sm font-semibold px-4 py-2 rounded-md transition w-full sm:w-auto">
                Edit Customer
            </button>
        </div>

        <!-- Contact Info Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 md:gap-4 pt-4 border-t border-border">
            <div>
                <div class="text-xs text-muted mb-1">Phone</div>
                {% if customer.phone %}
                <a href="tel:{{ customer.phone }}" class="text-brand hover:underline">{{ customer.phone }}</a>
                {% else %}
                <span class="text-muted">Not provided</span>
                {% endif %}
            </div>
            <div>
                <div class="text-xs text-muted mb-1">Address</div>
                {% if customer.address %}
                <a href="https://maps.google.com/?q={{ customer.address|urlencode }}" target="_blank" class="text-brand hover:underline">
                    {{ customer.address }}
                </a>
                {% else %}
                <span class="text-muted">Not provided</span>
                {% endif %}
            </div>
            <div>
                <div class="text-xs text-muted mb-1">Last Visit</div>
                {% if customer.last_visit %}
                <span>{{ customer.last_visit.strftime('%b %d, %Y') }}</span>
                {% set days_ago = (now - customer.last_visit).days %}
                {% if days_ago > 60 %}
                <span class="ml-1 text-xs bg-danger/20 text-danger px-1.5 py-0.5 rounded">{{ days_ago }}d ago</span>
                {% elif days_ago > 30 %}
                <span class="ml-1 text-xs bg-warn/20 text-warn px-1.5 py-0.5 rounded">{{ days_ago }}d ago</span>
                {% endif %}
                {% else %}
                <span class="text-danger">Never visited</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Balance & Stats Row -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mb-4">
        <div class="bg-panel rounded-xl shadow-soft p-3 md:p-4">
            <div class="text-xs text-muted mb-1">Current Balance</div>
            <div class="text-xl md:text-2xl font-semibold {% if customer.balance > 0 %}text-warn{% else %}text-good{% endif %}">
                ${{ "%.2f"|format(customer.balance) }}
            </div>
        </div>
        <div class="bg-panel rounded-xl shadow-soft p-3 md:p-4">
            <div class="text-xs text-muted mb-1">Total Paid</div>
            <div class="text-xl md:text-2xl font-semibold text-good">
                ${{ "%.2f"|format(customer.payments|sum(attribute='amount') if customer.payments else 0) }}
            </div>
        </div>
        <div class="bg-panel rounded-xl shadow-soft p-3 md:p-4">
            <div class="text-xs text-muted mb-1">Total Visits</div>
            <div class="text-xl md:text-2xl font-semibold">{{ customer.stops|length }}</div>
        </div>
        <div class="bg-panel rounded-xl shadow-soft p-3 md:p-4">
            <div class="text-xs text-muted mb-1">Total Payments</div>
            <div class="text-xl md:text-2xl font-semibold">{{ customer.payments|length }}</div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Transaction History -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">Transaction History</h2>
                {% if customer.balance > 0 %}
                <button
                    onclick="openPaymentModal()"
                    class="bg-good hover:bg-green-600 text-white text-xs font-semibold px-3 py-1.5 rounded transition">
                    + Record Payment
                </button>
                {% endif %}
            </div>

            <div class="space-y-2 max-h-96 overflow-y-auto">
                {% set sorted_payments = customer.payments|sort(attribute='payment_date', reverse=true) %}
                {% if sorted_payments %}
                    {% for payment in sorted_payments %}
                    <div class="flex items-center justify-between p-3 bg-panel2 rounded-lg">
                        <div>
                            <div class="font-semibold text-good">${{ "%.2f"|format(payment.amount) }}</div>
                            <div class="text-xs text-muted">{{ payment.payment_date.strftime('%b %d, %Y') }}</div>
                            {% if payment.notes %}
                            <div class="text-xs text-muted mt-1">{{ payment.notes }}</div>
                            {% endif %}
                        </div>
                        <form action="/customers/{{ customer.id }}/delete-payment/{{ payment.id }}" method="POST" class="inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button
                                type="submit"
                                onclick="return confirm('Delete this payment? This will restore the balance.')"
                                class="text-danger hover:text-red-400 p-1"
                                title="Delete payment">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-8 text-muted">
                        <div class="text-4xl mb-2">üí∞</div>
                        <div>No payment history</div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Visit History -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">Visit History</h2>
                <a href="/planner" class="text-brand hover:underline text-xs">+ Schedule Visit</a>
            </div>

            <div class="space-y-2 max-h-96 overflow-y-auto">
                {% set sorted_stops = customer.stops|sort(attribute='route_date', reverse=true) %}
                {% if sorted_stops %}
                    {% for stop in sorted_stops %}
                    <div class="flex items-center justify-between p-3 bg-panel2 rounded-lg">
                        <div>
                            <div class="font-semibold">{{ stop.route_date.strftime('%b %d, %Y') }}</div>
                            {% if stop.notes %}
                            <div class="text-xs text-muted mt-1">{{ stop.notes }}</div>
                            {% endif %}
                        </div>
                        {% if stop.completed %}
                        <span class="text-good text-xs font-semibold bg-good/10 px-2 py-1 rounded">Completed</span>
                        {% else %}
                        <span class="text-muted text-xs font-semibold bg-panel px-2 py-1 rounded">Pending</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-8 text-muted">
                        <div class="text-4xl mb-2">üìç</div>
                        <div>No visit history</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    {% if customer.notes %}
    <div class="bg-panel rounded-xl shadow-soft p-4 mt-4">
        <h2 class="text-lg font-semibold mb-2">Notes</h2>
        <div class="text-sm bg-panel2 p-3 rounded-lg">{{ customer.notes }}</div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="bg-panel rounded-xl shadow-soft p-4 mt-4">
        <h2 class="text-lg font-semibold mb-4">Quick Actions</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            {% if customer.phone %}
            <a href="tel:{{ customer.phone }}"
               class="bg-panel2 hover:bg-border text-center py-3 rounded-lg transition">
                <div class="text-2xl mb-1">üìû</div>
                <div class="text-xs font-semibold">Call</div>
            </a>
            {% endif %}
            {% if customer.address %}
            <a href="https://maps.google.com/?q={{ customer.address|urlencode }}" target="_blank"
               class="bg-panel2 hover:bg-border text-center py-3 rounded-lg transition">
                <div class="text-2xl mb-1">üó∫Ô∏è</div>
                <div class="text-xs font-semibold">Navigate</div>
            </a>
            {% endif %}
            <a href="/planner"
               class="bg-panel2 hover:bg-border text-center py-3 rounded-lg transition">
                <div class="text-2xl mb-1">üìÖ</div>
                <div class="text-xs font-semibold">Schedule Visit</div>
            </a>
            {% if customer.balance > 0 %}
            <button onclick="openPaymentModal()"
               class="bg-good/20 hover:bg-good/30 text-center py-3 rounded-lg transition">
                <div class="text-2xl mb-1">üí∞</div>
                <div class="text-xs font-semibold text-good">Record Payment</div>
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div onclick="closePaymentModal()" class="fixed inset-0 bg-black/50"></div>

        <div class="relative bg-panel rounded-xl shadow-2xl max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Record Payment</h3>
                <button onclick="closePaymentModal()" class="text-muted hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="bg-panel2 rounded-lg p-4 mb-4">
                <div class="text-xs text-muted mb-1">Current Balance</div>
                <div class="text-2xl font-semibold text-warn">${{ "%.2f"|format(customer.balance) }}</div>
            </div>

            <form action="/customers/{{ customer.id }}/add-payment" method="POST" class="space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <div>
                    <label class="block text-xs text-muted mb-1">Payment Amount *</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted">$</span>
                        <input type="number"
                               name="amount"
                               id="payment-amount"
                               step="0.01"
                               min="0.01"
                               value="{{ "%.2f"|format(customer.balance) }}"
                               required
                               class="w-full bg-panel2 border border-border rounded-md pl-8 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand">
                    </div>
                    <div class="mt-2 flex gap-2">
                        <button type="button" onclick="setPaymentAmount({{ customer.balance }})" class="text-xs bg-brand/20 text-brand px-2 py-1 rounded hover:bg-brand/30 transition">
                            Full Amount
                        </button>
                        <button type="button" onclick="setPaymentAmount({{ customer.balance / 2 }})" class="text-xs bg-panel2 text-muted px-2 py-1 rounded hover:bg-border transition">
                            Half
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-muted mb-1">Payment Date</label>
                    <input type="date"
                           name="payment_date"
                           value="{{ now.strftime('%Y-%m-%d') }}"
                           class="w-full bg-panel2 border border-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand">
                </div>

                <div>
                    <label class="block text-xs text-muted mb-1">Notes (optional)</label>
                    <input type="text"
                           name="notes"
                           class="w-full bg-panel2 border border-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand"
                           placeholder="Cash, check, etc...">
                </div>

                <div class="flex gap-2 pt-2">
                    <button type="submit"
                            class="flex-1 bg-good hover:bg-green-600 text-white text-sm font-semibold px-4 py-2 rounded-md transition">
                        Record Payment
                    </button>
                    <button type="button"
                            onclick="closePaymentModal()"
                            class="flex-1 bg-panel2 hover:bg-border text-white text-sm font-semibold px-4 py-2 rounded-md transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal Container -->
<div id="edit-modal-wrapper" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div onclick="closeEditModal()" class="fixed inset-0 bg-black/50"></div>
        <div id="edit-modal-content" class="relative bg-panel rounded-xl shadow-2xl max-w-md w-full p-6">
            <!-- Content loaded via HTMX -->
        </div>
    </div>
</div>

<script>
function openPaymentModal() {
    document.getElementById('payment-modal').style.display = 'block';
}

function closePaymentModal() {
    document.getElementById('payment-modal').style.display = 'none';
}

function setPaymentAmount(amount) {
    document.getElementById('payment-amount').value = amount.toFixed(2);
}

function openEditModal(customerId) {
    document.getElementById('edit-modal-wrapper').style.display = 'block';
    htmx.ajax('GET', '/customers/' + customerId + '/edit', '#edit-modal-content');
}

function closeEditModal() {
    document.getElementById('edit-modal-wrapper').style.display = 'none';
}
</script>

{% endblock %}
