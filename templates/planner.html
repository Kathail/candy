{% extends "base.html" %} {% block title %}Route Planner{% endblock %} {% block
content %}

<div x-data="plannerPage()">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-semibold">Route Planner</h1>
            <p class="text-xs text-muted mt-1">
                Schedule and optimize your routes
            </p>
        </div>
        <div class="flex gap-2">
            <button
                @click="showTemplates = true"
                class="bg-good hover:bg-green-600 text-white text-sm font-semibold px-4 py-2 rounded-md transition"
            >
                üîÑ Templates
            </button>
            <button
                @click="goToToday()"
                class="bg-brand hover:bg-blue-700 text-white text-sm font-semibold px-4 py-2 rounded-md transition"
            >
                üìç Today
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-panel rounded-lg p-4 shadow-soft">
            <div class="text-xs text-muted mb-1">This Week</div>
            <div class="text-2xl font-semibold">{{ weekly_routes }} routes</div>
        </div>
        <div class="bg-panel rounded-lg p-4 shadow-soft">
            <div class="text-xs text-muted mb-1">Total Stops</div>
            <div class="text-2xl font-semibold">{{ total_planned_stops }}</div>
        </div>
        <div class="bg-panel rounded-lg p-4 shadow-soft">
            <div class="text-xs text-muted mb-1">Available</div>
            <div class="text-2xl font-semibold text-good">
                {{ customers|length }}
            </div>
        </div>
        <div class="bg-panel rounded-lg p-4 shadow-soft">
            <div class="text-xs text-muted mb-1">Need Visit</div>
            <div class="text-2xl font-semibold text-warn">
                {{ needs_visit }}
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <!-- LEFT: Calendar -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="flex items-center justify-between mb-4">
                <button
                    @click="previousMonth()"
                    class="p-1 hover:bg-panel2 rounded transition"
                >
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 19l-7-7 7-7"
                        />
                    </svg>
                </button>
                <div
                    class="text-sm font-semibold"
                    x-text="currentMonthName"
                ></div>
                <button
                    @click="nextMonth()"
                    class="p-1 hover:bg-panel2 rounded transition"
                >
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5l7 7-7 7"
                        />
                    </svg>
                </button>
            </div>

            <!-- Calendar Grid -->
            <div class="grid grid-cols-7 gap-1 mb-4">
                <template x-for="day in ['S', 'M', 'T', 'W', 'T', 'F', 'S']">
                    <div
                        class="text-center text-xs text-muted font-semibold py-1"
                        x-text="day"
                    ></div>
                </template>

                <template x-for="day in calendarDays" :key="day.date">
                    <button
                        @click="selectDate(day.date)"
                        :disabled="!day.isCurrentMonth"
                        :class="{
                            'opacity-30': !day.isCurrentMonth,
                            'bg-brand text-white': day.isSelected,
                            'bg-good/20 text-good border-good': day.hasStops && !day.isSelected,
                            'hover:bg-panel2': day.isCurrentMonth && !day.isSelected,
                            'ring-2 ring-warn': day.isToday && !day.isSelected
                        }"
                        class="aspect-square p-1 rounded-md transition relative text-xs border border-transparent"
                    >
                        <div class="font-semibold" x-text="day.day"></div>
                        <div
                            x-show="day.stopCount > 0"
                            class="text-[10px] absolute bottom-0 right-0.5"
                            x-text="day.stopCount"
                        ></div>
                    </button>
                </template>
            </div>

            <!-- Quick Actions -->
            <div class="space-y-2 pt-4 border-t border-border">
                <button
                    @click="showCityBulkAdd = true"
                    :disabled="!selectedDate"
                    class="w-full bg-brand hover:bg-blue-700 disabled:bg-panel2 disabled:text-muted text-white text-xs font-semibold px-3 py-2 rounded transition"
                >
                    üèôÔ∏è Add by City
                </button>
                <button
                    @click="saveTemplate()"
                    :disabled="!selectedDate || currentStops.length === 0"
                    class="w-full bg-good hover:bg-green-600 disabled:bg-panel2 disabled:text-muted text-white text-xs font-semibold px-3 py-2 rounded transition"
                >
                    üíæ Save Template
                </button>
            </div>
        </div>

        <!-- CENTER: Customer Pool -->
        <div class="lg:col-span-2 bg-panel rounded-xl shadow-soft p-4">
            <div class="flex items-center justify-between mb-4">
                <div class="text-sm font-semibold">Available Customers</div>
                <span class="text-xs text-muted"
                    ><span x-text="filteredCustomers.length"></span> of {{
                    customers|length }}</span
                >
            </div>

            <!-- Search & Filter -->
            <div class="space-y-3 mb-4">
                <input
                    type="text"
                    placeholder="Search customers..."
                    class="w-full bg-panel2 border border-border rounded-md px-4 py-2 text-sm placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand"
                    x-model="query"
                    @input="filterCustomers()"
                />

                <div class="flex gap-2">
                    <button
                        @click="customerFilter = 'all'; filterCustomers()"
                        :class="customerFilter === 'all' ? 'bg-brand text-white' : 'bg-panel2 text-muted'"
                        class="px-3 py-1.5 rounded text-xs font-semibold transition"
                    >
                        All
                    </button>
                    <button
                        @click="customerFilter = 'never'; filterCustomers()"
                        :class="customerFilter === 'never' ? 'bg-brand text-white' : 'bg-panel2 text-muted'"
                        class="px-3 py-1.5 rounded text-xs font-semibold transition"
                    >
                        Never Visited
                    </button>
                    <button
                        @click="customerFilter = 'overdue'; filterCustomers()"
                        :class="customerFilter === 'overdue' ? 'bg-brand text-white' : 'bg-panel2 text-muted'"
                        class="px-3 py-1.5 rounded text-xs font-semibold transition"
                    >
                        30+ Days
                    </button>
                </div>
            </div>

            <!-- Customer List -->
            <div class="space-y-2 scrollable-container-lg">
                <template
                    x-for="customer in filteredCustomers"
                    :key="customer.id"
                >
                    <div
                        class="flex items-center justify-between p-3 bg-panel2 rounded-lg hover:bg-border transition"
                    >
                        <div
                            class="flex-1 cursor-pointer"
                            @click="openCustomerModal(customer)"
                        >
                            <div
                                class="text-sm font-semibold"
                                x-text="customer.name"
                            ></div>
                            <div class="flex items-center gap-3 mt-1">
                                <span
                                    class="text-xs text-muted"
                                    x-text="customer.city"
                                ></span>
                                <span
                                    class="text-xs"
                                    :class="!customer.last_visit ? 'text-danger' : customer.needs_visit ? 'text-warn' : 'text-muted'"
                                >
                                    Last:
                                    <span
                                        x-text="customer.last_visit || 'Never'"
                                    ></span>
                                </span>
                                <span
                                    x-show="customer.balance > 0"
                                    class="text-xs text-warn"
                                >
                                    $<span
                                        x-text="customer.balance.toFixed(2)"
                                    ></span>
                                </span>
                            </div>
                        </div>
                        <button
                            @click="addToRoute(customer)"
                            :disabled="!selectedDate"
                            class="bg-brand hover:bg-blue-700 disabled:bg-panel2 disabled:text-muted disabled:cursor-not-allowed text-white text-xs font-semibold px-4 py-2 rounded transition"
                        >
                            Add ‚Üí
                        </button>
                    </div>
                </template>

                <div
                    x-show="filteredCustomers.length === 0"
                    class="text-center py-12"
                >
                    <div class="text-4xl mb-3">üîç</div>
                    <div class="text-sm font-semibold mb-1">
                        No customers found
                    </div>
                    <div class="text-xs text-muted">
                        Try adjusting your search or filters
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Route Builder -->
        <div
            class="lg:sticky lg:top-4 lg:self-start bg-panel rounded-xl shadow-soft p-4"
        >
            <div class="flex items-center justify-between mb-4">
                <div>
                    <div
                        class="text-sm font-semibold"
                        x-text="selectedDate ? formatDate(selectedDate) : 'No Date Selected'"
                    ></div>
                    <div
                        class="text-xs text-muted"
                        x-text="selectedDate ? getDayName(selectedDate) : 'Select date from calendar'"
                    ></div>
                </div>
                <span
                    x-show="currentStops.length > 0"
                    class="text-xs bg-brand/20 text-brand px-2 py-1 rounded font-semibold"
                >
                    <span x-text="currentStops.length"></span> stops
                </span>
            </div>

            <!-- Stops List -->
            <div
                x-show="currentStops.length > 0"
                class="space-y-2 mb-4 max-h-[500px] overflow-y-auto"
            >
                <template x-for="(stop, index) in currentStops" :key="stop.id">
                    <div class="bg-panel2 rounded-lg p-3 border border-border">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center gap-2 flex-1">
                                <div
                                    class="flex items-center justify-center w-6 h-6 rounded-full bg-brand text-xs font-semibold"
                                    x-text="index + 1"
                                ></div>
                                <div class="flex-1">
                                    <div
                                        class="text-sm font-semibold"
                                        x-text="stop.customer_name"
                                    ></div>
                                    <div
                                        class="text-xs text-muted"
                                        x-text="stop.customer_city"
                                    ></div>
                                </div>
                            </div>
                            <button
                                @click="removeStop(stop.id)"
                                class="text-danger hover:bg-danger/10 p-1 rounded transition"
                            >
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"
                                    />
                                </svg>
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Empty State -->
            <div x-show="!selectedDate" class="text-center py-8">
                <div class="text-4xl mb-3">üìÖ</div>
                <div class="text-sm font-semibold mb-2">Select a Date</div>
                <div class="text-xs text-muted">
                    Click a date on the calendar to start
                </div>
            </div>

            <div
                x-show="selectedDate && currentStops.length === 0"
                class="text-center py-8"
            >
                <div class="text-4xl mb-3">üìç</div>
                <div class="text-sm font-semibold mb-2">No Stops Yet</div>
                <div class="text-xs text-muted">
                    Add customers from the list or use bulk add
                </div>
            </div>

            <!-- Actions -->
            <div
                x-show="currentStops.length > 0"
                class="space-y-2 pt-4 border-t border-border"
            >
                <button
                    @click="optimizeRoute()"
                    class="w-full bg-brand hover:bg-blue-700 text-white text-sm font-semibold px-4 py-2 rounded-md transition"
                >
                    üó∫Ô∏è Optimize Route
                </button>
                <button
                    @click="clearRoute()"
                    class="w-full bg-danger hover:bg-red-600 text-white text-sm font-semibold px-4 py-2 rounded-md transition"
                >
                    üóëÔ∏è Clear All
                </button>
            </div>
        </div>
    </div>

    <!-- City Bulk Add Modal -->
    <div
        x-show="showCityBulkAdd"
        x-cloak
        @keydown.escape.window="showCityBulkAdd = false"
        class="fixed inset-0 z-50 overflow-y-auto"
        style="display: none"
    >
        <div class="flex items-center justify-center min-h-screen px-4">
            <div
                @click="showCityBulkAdd = false"
                class="fixed inset-0 bg-black/50"
            ></div>

            <div
                class="relative bg-panel rounded-xl shadow-2xl max-w-md w-full p-6"
            >
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Add by City</h3>
                    <button
                        @click="showCityBulkAdd = false"
                        class="text-muted hover:text-white"
                    >
                        <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"
                            />
                        </svg>
                    </button>
                </div>

                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <template x-for="city in cityGroups" :key="city.name">
                        <button
                            @click="addCityToRoute(city.name)"
                            class="w-full flex items-center justify-between p-3 bg-panel2 hover:bg-border rounded-lg transition"
                        >
                            <div>
                                <div
                                    class="text-sm font-semibold"
                                    x-text="city.name"
                                ></div>
                                <div class="text-xs text-muted">
                                    <span x-text="city.count"></span> customers
                                </div>
                            </div>
                            <svg
                                class="w-5 h-5 text-brand"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 4v16m8-8H4"
                                />
                            </svg>
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div
        x-show="showTemplates"
        x-cloak
        @keydown.escape.window="showTemplates = false"
        class="fixed inset-0 z-50 overflow-y-auto"
        style="display: none"
    >
        <div class="flex items-center justify-center min-h-screen px-4">
            <div
                @click="showTemplates = false"
                class="fixed inset-0 bg-black/50"
            ></div>

            <div
                class="relative bg-panel rounded-xl shadow-2xl max-w-2xl w-full p-6"
            >
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Route Templates</h3>
                    <button
                        @click="showTemplates = false"
                        class="text-muted hover:text-white"
                    >
                        <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"
                            />
                        </svg>
                    </button>
                </div>

                <div x-show="templates.length === 0" class="text-center py-12">
                    <div class="text-4xl mb-3">üìã</div>
                    <div class="text-sm font-semibold mb-2">
                        No Templates Yet
                    </div>
                    <div class="text-xs text-muted">
                        Create a route and click "Save Template" to get started
                    </div>
                </div>

                <div class="space-y-3">
                    <template x-for="template in templates" :key="template.id">
                        <div class="bg-panel2 rounded-lg p-4">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <div
                                        class="text-sm font-semibold"
                                        x-text="template.name"
                                    ></div>
                                    <div class="text-xs text-muted">
                                        <span
                                            x-text="template.stops.length"
                                        ></span>
                                        stops
                                    </div>
                                </div>
                                <button
                                    @click="deleteTemplate(template.id)"
                                    class="text-danger hover:bg-danger/10 p-1 rounded transition"
                                >
                                    <svg
                                        class="w-4 h-4"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                        />
                                    </svg>
                                </button>
                            </div>

                            <div class="text-xs text-muted mb-3">
                                <span
                                    x-text="template.stops.map(s => s.customer_name).join(', ')"
                                ></span>
                            </div>

                            <div class="flex gap-2">
                                <button
                                    @click="applyTemplate(template.id)"
                                    :disabled="!selectedDate"
                                    class="flex-1 bg-brand hover:bg-blue-700 disabled:bg-panel2 disabled:text-muted text-white text-xs font-semibold px-3 py-2 rounded transition"
                                >
                                    Apply to Selected Date
                                </button>
                                <button
                                    @click="showRecurring = true; selectedTemplateId = template.id"
                                    class="flex-1 bg-good hover:bg-green-600 text-white text-xs font-semibold px-3 py-2 rounded transition"
                                >
                                    Setup Recurring
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Recurring Setup Modal -->
    <div
        x-show="showRecurring"
        x-cloak
        @keydown.escape.window="showRecurring = false"
        class="fixed inset-0 z-50 overflow-y-auto"
        style="display: none"
    >
        <div class="flex items-center justify-center min-h-screen px-4">
            <div
                @click="showRecurring = false"
                class="fixed inset-0 bg-black/50"
            ></div>

            <div
                class="relative bg-panel rounded-xl shadow-2xl max-w-md w-full p-6"
            >
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Setup Recurring Route</h3>
                    <button
                        @click="showRecurring = false"
                        class="text-muted hover:text-white"
                    >
                        <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"
                            />
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs text-muted mb-2"
                            >Repeat Every</label
                        >
                        <div class="flex gap-2">
                            <input
                                type="number"
                                x-model="recurringInterval"
                                min="1"
                                max="52"
                                class="w-20 bg-panel2 border border-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand"
                            />
                            <select
                                x-model="recurringUnit"
                                class="flex-1 bg-panel2 border border-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand"
                            >
                                <option value="days">Days</option>
                                <option value="weeks">Weeks</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs text-muted mb-2"
                            >Start Date</label
                        >
                        <input
                            type="date"
                            x-model="recurringStartDate"
                            class="w-full bg-panel2 border border-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand"
                        />
                    </div>

                    <div>
                        <label class="block text-xs text-muted mb-2"
                            >Number of Occurrences</label
                        >
                        <input
                            type="number"
                            x-model="recurringCount"
                            min="1"
                            max="52"
                            class="w-full bg-panel2 border border-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand"
                        />
                    </div>

                    <div class="pt-4 border-t border-border">
                        <button
                            @click="applyRecurring()"
                            class="w-full bg-good hover:bg-green-600 text-white text-sm font-semibold px-4 py-2 rounded-md transition"
                        >
                            Create Recurring Routes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Profile Modal -->
    <div
        x-show="showCustomerModal"
        x-cloak
        @keydown.escape.window="showCustomerModal = false"
        class="fixed inset-0 z-50 overflow-y-auto"
        style="display: none"
    >
        <div class="flex items-center justify-center min-h-screen px-4">
            <div
                @click="showCustomerModal = false"
                class="fixed inset-0 bg-black/50"
            ></div>

            <div
                class="relative bg-panel rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto"
            >
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3
                            class="text-xl font-semibold"
                            x-text="selectedCustomer?.name"
                        ></h3>
                        <p
                            class="text-sm text-muted"
                            x-text="selectedCustomer?.city"
                        ></p>
                    </div>
                    <button
                        @click="showCustomerModal = false"
                        class="text-muted hover:text-white"
                    >
                        <svg
                            class="w-6 h-6"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"
                            />
                        </svg>
                    </button>
                </div>

                <!-- Loading State -->
                <div x-show="loadingCustomerDetails" class="text-center py-8">
                    <div class="text-2xl mb-2">‚è≥</div>
                    <div class="text-sm text-muted">Loading details...</div>
                </div>

                <!-- Customer Details -->
                <div
                    x-show="!loadingCustomerDetails && customerDetails"
                    class="space-y-6"
                >
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-panel2 rounded-lg p-4">
                            <div class="text-xs text-muted mb-1">Balance</div>
                            <div
                                class="text-2xl font-semibold"
                                :class="customerDetails?.customer?.balance > 0 ? 'text-warn' : 'text-good'"
                            >
                                $<span
                                    x-text="customerDetails?.customer?.balance?.toFixed(2)"
                                ></span>
                            </div>
                        </div>

                        <div class="bg-panel2 rounded-lg p-4">
                            <div class="text-xs text-muted mb-1">
                                Last Visit
                            </div>
                            <div
                                class="text-sm font-semibold"
                                x-text="customerDetails?.customer?.last_visit || 'Never'"
                            ></div>
                        </div>

                        <div class="bg-panel2 rounded-lg p-4">
                            <div class="text-xs text-muted mb-1">
                                Total Visits
                            </div>
                            <div
                                class="text-2xl font-semibold"
                                x-text="customerDetails?.visits?.length || 0"
                            ></div>
                        </div>

                        <div class="bg-panel2 rounded-lg p-4">
                            <div class="text-xs text-muted mb-1">
                                Total Paid
                            </div>
                            <div class="text-2xl font-semibold text-good">
                                $<span
                                    x-text="(customerDetails?.payments || []).reduce((sum, p) => sum + p.amount, 0).toFixed(2)"
                                ></span>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Info -->
                    <div class="bg-panel2 rounded-lg p-4">
                        <div class="text-sm font-semibold mb-3">
                            Contact Information
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <svg
                                    class="w-4 h-4 text-muted"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                                    />
                                </svg>
                                <a
                                    :href="'tel:' + customerDetails?.customer?.phone"
                                    class="text-brand hover:underline"
                                    x-text="customerDetails?.customer?.phone"
                                ></a>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg
                                    class="w-4 h-4 text-muted"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                                    />
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                                    />
                                </svg>
                                <a
                                    :href="'https://maps.google.com/?q=' + encodeURIComponent(customerDetails?.customer?.address)"
                                    target="_blank"
                                    class="text-brand hover:underline"
                                    x-text="customerDetails?.customer?.address"
                                ></a>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div
                        x-show="customerDetails?.customer?.notes"
                        class="bg-panel2 rounded-lg p-4"
                    >
                        <div class="text-sm font-semibold mb-2">Notes</div>
                        <div
                            class="text-sm text-muted whitespace-pre-wrap"
                            x-text="customerDetails?.customer?.notes"
                        ></div>
                    </div>

                    <!-- Recent Payments -->
                    <div
                        x-show="customerDetails?.payments?.length > 0"
                        class="bg-panel2 rounded-lg p-4"
                    >
                        <div class="text-sm font-semibold mb-3">
                            Recent Payments
                        </div>
                        <div class="space-y-2">
                            <template
                                x-for="payment in customerDetails?.payments?.slice(0, 5)"
                                :key="payment.id"
                            >
                                <div
                                    class="flex items-center justify-between text-sm"
                                >
                                    <div>
                                        <div
                                            class="font-semibold"
                                            x-text="'$' + payment.amount.toFixed(2)"
                                        ></div>
                                        <div
                                            class="text-xs text-muted"
                                            x-text="payment.date"
                                        ></div>
                                    </div>
                                    <div
                                        class="text-xs text-muted"
                                        x-text="payment.notes || 'No notes'"
                                    ></div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Recent Visits -->
                    <div
                        x-show="customerDetails?.visits?.length > 0"
                        class="bg-panel2 rounded-lg p-4"
                    >
                        <div class="text-sm font-semibold mb-3">
                            Recent Visits
                        </div>
                        <div class="space-y-2">
                            <template
                                x-for="visit in customerDetails?.visits?.slice(0, 5)"
                                :key="visit.id"
                            >
                                <div
                                    class="flex items-center justify-between text-sm"
                                >
                                    <div
                                        class="text-xs"
                                        x-text="visit.date"
                                    ></div>
                                    <span
                                        x-show="visit.completed"
                                        class="text-xs bg-good/20 text-good px-2 py-0.5 rounded"
                                        >‚úì Completed</span
                                    >
                                    <span
                                        x-show="!visit.completed"
                                        class="text-xs bg-panel text-muted px-2 py-0.5 rounded"
                                        >Planned</span
                                    >
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-2 pt-4 border-t border-border">
                        <button
                            @click="addToRoute(selectedCustomer); showCustomerModal = false"
                            :disabled="!selectedDate"
                            class="flex-1 bg-brand hover:bg-blue-700 disabled:bg-panel2 disabled:text-muted text-white text-sm font-semibold px-4 py-2 rounded-md transition"
                        >
                            Add to Route
                        </button>
                        <a
                            :href="'/customers'"
                            class="flex-1 bg-panel2 hover:bg-border text-white text-center text-sm font-semibold px-4 py-2 rounded-md transition"
                        >
                            All Customers
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    [x-cloak] {
        display: none !important;
    }
</style>

<script>
    // Helper function to format date as YYYY-MM-DD in local timezone
    function formatDateLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function plannerPage() {
        return {
            query: '',
            customerFilter: 'all',
            customers: {{ customers_json|safe }},
            filteredCustomers: [],
            allStops: {},
            currentStops: [],

            showCustomerModal: false,
            selectedCustomer: null,
            loadingCustomerDetails: false,
            customerDetails: null,

            showCityBulkAdd: false,
            cityGroups: [],

            showTemplates: false,
            templates: [],

            showRecurring: false,
            selectedTemplateId: null,
            recurringInterval: 7,
            recurringUnit: 'days',
            recurringStartDate: formatDateLocal(new Date()),
            recurringCount: 4,

            selectedDate: null,
            calendarYear: new Date().getFullYear(),
            calendarMonth: new Date().getMonth(),
            calendarDays: [],

            init() {
                this.filteredCustomers = this.customers;
                this.loadAllStops();
                this.generateCalendar();
                this.goToToday();
                this.groupCustomersByCity();
                this.loadTemplates();
            },

            groupCustomersByCity() {
                const cityMap = {};
                this.customers.forEach(c => {
                    const city = c.city || 'Unknown';
                    if (!cityMap[city]) {
                        cityMap[city] = { name: city, count: 0, customers: [] };
                    }
                    cityMap[city].count++;
                    cityMap[city].customers.push(c);
                });

                this.cityGroups = Object.values(cityMap).sort((a, b) => b.count - a.count);
            },

            async addCityToRoute(cityName) {
                if (!this.selectedDate) {
                    alert('Please select a date first!');
                    return;
                }

                const cityGroup = this.cityGroups.find(c => c.name === cityName);
                if (!cityGroup) return;

                for (const customer of cityGroup.customers) {
                    // Check if already scheduled
                    if (this.currentStops.some(s => s.customer_id === customer.id)) continue;

                    await this.addToRoute(customer, true); // silent mode
                }

                this.showCityBulkAdd = false;
                this.showToast(`‚úì Added all ${cityName} customers`);
            },

            loadTemplates() {
                const stored = localStorage.getItem('routeTemplates');
                this.templates = stored ? JSON.parse(stored) : [];
            },

            saveTemplate() {
                if (this.currentStops.length === 0) return;

                const name = prompt('Template name:', `Route - ${this.formatDate(this.selectedDate)}`);
                if (!name) return;

                const template = {
                    id: Date.now(),
                    name: name,
                    stops: this.currentStops.map(s => ({
                        customer_id: s.customer_id,
                        customer_name: s.customer_name,
                        customer_city: s.customer_city
                    }))
                };

                this.templates.push(template);
                localStorage.setItem('routeTemplates', JSON.stringify(this.templates));
                this.showToast('‚úì Template saved!');
            },

            async applyTemplate(templateId) {
                if (!this.selectedDate) {
                    alert('Please select a date first!');
                    return;
                }

                const template = this.templates.find(t => t.id === templateId);
                if (!template) return;

                // Clear current route
                if (this.currentStops.length > 0) {
                    await this.clearRoute(true); // silent mode
                }

                // Add all stops from template
                for (const stop of template.stops) {
                    const customer = this.customers.find(c => c.id === stop.customer_id);
                    if (customer) {
                        await this.addToRoute(customer, true); // silent mode
                    }
                }

                this.showTemplates = false;
                this.showToast(`‚úì Applied template: ${template.name}`);
            },

            async applyRecurring() {
                const template = this.templates.find(t => t.id === this.selectedTemplateId);
                if (!template) return;

                const startDate = new Date(this.recurringStartDate);
                const intervalDays = this.recurringUnit === 'weeks' ? this.recurringInterval * 7 : this.recurringInterval;

                for (let i = 0; i < this.recurringCount; i++) {
                    const targetDate = new Date(startDate);
                    targetDate.setDate(targetDate.getDate() + (intervalDays * i));
                    const dateStr = targetDate.toISOString().split('T')[0];

                    // Add stops for this date
                    for (const stop of template.stops) {
                        const customer = this.customers.find(c => c.id === stop.customer_id);
                        if (!customer) continue;

                        const formData = new FormData();
                        formData.append('customer_id', customer.id);
                        formData.append('route_date', dateStr);

                        try {
                            await fetch('/planner/add-stop', {
                                method: 'POST',
                                body: formData
                            });
                        } catch (error) {
                            console.error('Error:', error);
                        }
                    }
                }

                // Reload all stops
                await this.loadAllStops();
                this.generateCalendar();

                this.showRecurring = false;
                this.showTemplates = false;
                this.showToast(`‚úì Created ${this.recurringCount} recurring routes!`);
            },

            deleteTemplate(templateId) {
                if (!confirm('Delete this template?')) return;

                this.templates = this.templates.filter(t => t.id !== templateId);
                localStorage.setItem('routeTemplates', JSON.stringify(this.templates));
                this.showToast('‚úì Template deleted');
            },

            async loadAllStops() {
                try {
                    const response = await fetch('/planner/all-stops');
                    const data = await response.json();
                    this.allStops = data.stops;
                    this.generateCalendar();
                } catch (error) {
                    console.error('Error loading stops:', error);
                }
            },

            filterCustomers() {
                let filtered = this.customers;

                if (this.query) {
                    const q = this.query.toLowerCase();
                    filtered = filtered.filter(c =>
                        c.name.toLowerCase().includes(q) ||
                        c.city.toLowerCase().includes(q)
                    );
                }

                if (this.customerFilter === 'never') {
                    filtered = filtered.filter(c => !c.last_visit);
                } else if (this.customerFilter === 'overdue') {
                    filtered = filtered.filter(c => c.needs_visit);
                }

                if (this.selectedDate && this.currentStops.length > 0) {
                    const scheduledIds = this.currentStops.map(s => s.customer_id);
                    filtered = filtered.filter(c => !scheduledIds.includes(c.id));
                }

                this.filteredCustomers = filtered;
            },

            openCustomerModal(customer) {
                this.selectedCustomer = customer;
                this.showCustomerModal = true;
                this.loadCustomerDetails(customer.id);
            },

            async loadCustomerDetails(customerId) {
                this.loadingCustomerDetails = true;
                this.customerDetails = null;

                try {
                    const response = await fetch(`/customer/${customerId}/details`);
                    const data = await response.json();
                    this.customerDetails = data;
                } catch (error) {
                    console.error('Error loading customer details:', error);
                } finally {
                    this.loadingCustomerDetails = false;
                }
            },

            generateCalendar() {
                const firstDay = new Date(this.calendarYear, this.calendarMonth, 1);
                const lastDay = new Date(this.calendarYear, this.calendarMonth + 1, 0);
                const prevLastDay = new Date(this.calendarYear, this.calendarMonth, 0);

                const firstDayWeekday = firstDay.getDay();
                const lastDayDate = lastDay.getDate();
                const prevLastDayDate = prevLastDay.getDate();

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const days = [];

                for (let i = firstDayWeekday - 1; i >= 0; i--) {
                    const day = prevLastDayDate - i;
                    const date = new Date(this.calendarYear, this.calendarMonth - 1, day);
                    days.push(this.createDayObject(date, day, false));
                }

                for (let day = 1; day <= lastDayDate; day++) {
                    const date = new Date(this.calendarYear, this.calendarMonth, day);
                    days.push(this.createDayObject(date, day, true));
                }

                const remainingDays = 42 - days.length;
                for (let day = 1; day <= remainingDays; day++) {
                    const date = new Date(this.calendarYear, this.calendarMonth + 1, day);
                    days.push(this.createDayObject(date, day, false));
                }

                this.calendarDays = days;
            },

            createDayObject(date, day, isCurrentMonth) {
                const dateStr = formatDateLocal(date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const stops = this.allStops[dateStr] || [];

                return {
                    date: dateStr,
                    day: day,
                    isCurrentMonth: isCurrentMonth,
                    isToday: date.getTime() === today.getTime(),
                    isSelected: dateStr === this.selectedDate,
                    hasStops: stops.length > 0,
                    stopCount: stops.length
                };
            },

            get currentMonthName() {
                const date = new Date(this.calendarYear, this.calendarMonth);
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            },

            previousMonth() {
                if (this.calendarMonth === 0) {
                    this.calendarMonth = 11;
                    this.calendarYear--;
                } else {
                    this.calendarMonth--;
                }
                this.generateCalendar();
            },

            nextMonth() {
                if (this.calendarMonth === 11) {
                    this.calendarMonth = 0;
                    this.calendarYear++;
                } else {
                    this.calendarMonth++;
                }
                this.generateCalendar();
            },

            goToToday() {
                const today = new Date();
                this.selectedDate = formatDateLocal(today);
                this.calendarYear = today.getFullYear();
                this.calendarMonth = today.getMonth();
                this.loadStopsForDate();
                this.generateCalendar();
            },

            selectDate(dateStr) {
                this.selectedDate = dateStr;
                this.loadStopsForDate();
                this.generateCalendar();
            },

            formatDate(dateStr) {
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            },

            getDayName(dateStr) {
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('en-US', { weekday: 'long' });
            },

            async loadStopsForDate() {
                if (!this.selectedDate) return;

                this.currentStops = this.allStops[this.selectedDate] || [];
                this.filterCustomers();
            },

            async addToRoute(customer, silent = false) {
                if (!this.selectedDate) {
                    if (!silent) alert('Please select a date first!');
                    return;
                }

                const formData = new FormData();
                formData.append('customer_id', customer.id);
                formData.append('route_date', this.selectedDate);

                try {
                    const response = await fetch('/planner/add-stop', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.currentStops.push({
                            id: data.stop_id,
                            customer_id: customer.id,
                            customer_name: customer.name,
                            customer_city: customer.city,
                            sequence: this.currentStops.length + 1
                        });

                        this.allStops[this.selectedDate] = this.currentStops;
                        this.generateCalendar();
                        this.filterCustomers();

                        if (!silent) this.showToast(`‚úì Added ${customer.name} to route`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    if (!silent) alert('Failed to add stop');
                }
            },

            async removeStop(stopId) {
                try {
                    const response = await fetch(`/planner/stop/${stopId}/remove`, {
                        method: 'POST'
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.currentStops = this.currentStops.filter(s => s.id !== stopId);
                        this.allStops[this.selectedDate] = this.currentStops;
                        this.generateCalendar();
                        this.filterCustomers();
                        this.showToast('‚úì Stop removed');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            async optimizeRoute() {
                if (!this.selectedDate || this.currentStops.length === 0) return;

                try {
                    const response = await fetch(`/planner/route/${this.selectedDate}/optimize`, {
                        method: 'POST'
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.currentStops = data.stops;
                        this.allStops[this.selectedDate] = this.currentStops;
                        this.showToast('‚úì Route optimized!');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            async clearRoute(silent = false) {
                if (!silent && !confirm('Clear all stops from this route?')) return;

                try {
                    const response = await fetch(`/planner/route/${this.selectedDate}/clear`, {
                        method: 'POST'
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.currentStops = [];
                        this.allStops[this.selectedDate] = [];
                        this.generateCalendar();
                        this.filterCustomers();
                        if (!silent) this.showToast('‚úì Route cleared');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-4 right-4 bg-good text-white px-4 py-3 rounded-lg shadow-lg z-50';
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            }
        };
    }
</script>

{% endblock %}
