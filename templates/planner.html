{% extends "base.html" %} {% block title %}Route Planner{% endblock %} {% block
content %}
<div x-data="plannerPage()">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-2xl font-semibold">Route Planner</h1>
            <p class="text-xs text-muted mt-1">
                Schedule visits and optimize your routes
            </p>
        </div>
        <button
            @click="showDatePicker = !showDatePicker"
            class="bg-brand hover:bg-blue-700 text-white text-xs font-semibold px-4 py-2 rounded-md transition"
        >
            + Plan New Route
        </button>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="bg-panel rounded-lg p-3 shadow-soft">
            <div class="text-xs text-muted">This Week</div>
            <div class="text-xl font-semibold">{{ weekly_routes }} routes</div>
        </div>
        <div class="bg-panel rounded-lg p-3 shadow-soft">
            <div class="text-xs text-muted">Total Stops</div>
            <div class="text-xl font-semibold">{{ total_planned_stops }}</div>
        </div>
        <div class="bg-panel rounded-lg p-3 shadow-soft">
            <div class="text-xs text-muted">Available</div>
            <div class="text-xl font-semibold text-good">
                {{ customers|length }}
            </div>
        </div>
        <div class="bg-panel rounded-lg p-3 shadow-soft">
            <div class="text-xs text-muted">Need Visit</div>
            <div class="text-xl font-semibold text-warn">{{ needs_visit }}</div>
        </div>
    </div>

    <!-- Main Planner Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- LEFT: Upcoming Routes -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="flex items-center justify-between mb-3">
                <div class="text-sm font-semibold">Upcoming Routes</div>
                <span class="text-xs text-muted">Next 7 days</span>
            </div>

            <div class="space-y-2">
                {% if upcoming_routes %} {% for route in upcoming_routes %}
                <div
                    class="p-3 rounded-lg cursor-pointer hover:bg-panel2 transition border border-border"
                    :class="selectedDate === '{{ route.date }}' ? 'bg-panel2 border-brand' : ''"
                    @click="selectedDate = '{{ route.date }}'"
                    hx-get="/planner/date/{{ route.date }}"
                    hx-target="#route-builder"
                    hx-swap="innerHTML"
                >
                    <div class="flex items-center justify-between mb-1">
                        <div class="text-sm font-semibold">
                            {{ route.date_formatted }}
                        </div>
                        <span
                            class="text-xs font-semibold bg-brand/20 text-brand px-2 py-0.5 rounded"
                        >
                            {{ route.stop_count }} stops
                        </span>
                    </div>
                    <div class="text-xs text-muted">{{ route.day_name }}</div>
                    {% if route.stop_count > 0 %}
                    <div class="mt-2 pt-2 border-t border-border">
                        <div class="text-xs text-muted">
                            First: {{ route.first_customer }}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %} {% else %}
                <div class="text-center py-8">
                    <div class="text-3xl mb-2">üìÖ</div>
                    <div class="text-xs text-muted">No routes planned yet</div>
                    <button
                        @click="showDatePicker = true"
                        class="mt-3 text-xs text-brand hover:underline"
                    >
                        Create your first route ‚Üí
                    </button>
                </div>
                {% endif %}

                <!-- Quick Date Selector -->
                <div class="pt-3 border-t border-border">
                    <div class="text-xs text-muted mb-2">Quick Add</div>
                    <div class="grid grid-cols-2 gap-2">
                        {% for i in range(7) %} {% set future_date = (now +
                        timedelta(days=i)).strftime('%Y-%m-%d') %} {% set
                        day_name = (now + timedelta(days=i)).strftime('%a') %}
                        <button
                            @click="selectedDate = '{{ future_date }}'"
                            hx-get="/planner/date/{{ future_date }}"
                            hx-target="#route-builder"
                            hx-swap="innerHTML"
                            class="text-xs bg-panel2 hover:bg-border px-2 py-1.5 rounded transition"
                        >
                            {{ day_name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- CENTER: Customer Pool -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="flex items-center justify-between mb-3">
                <div class="text-sm font-semibold">Available Customers</div>
                <span class="text-xs text-muted"
                    >{{ customers|length }} total</span
                >
            </div>

            <!-- Search -->
            <input
                type="text"
                placeholder="Search customers‚Ä¶"
                class="w-full mb-3 bg-panel2 border border-border rounded-md px-3 py-2 text-sm placeholder:text-muted focus:outline-none focus:ring-1 focus:ring-brand"
                x-model="query"
                @input="filterCustomers()"
            />

            <!-- Filter Tabs -->
            <div class="flex gap-2 mb-3 text-xs">
                <button
                    @click="customerFilter = 'all'; filterCustomers()"
                    :class="customerFilter === 'all' ? 'bg-brand text-white' : 'bg-panel2 text-muted'"
                    class="px-3 py-1.5 rounded transition"
                >
                    All
                </button>
                <button
                    @click="customerFilter = 'never'; filterCustomers()"
                    :class="customerFilter === 'never' ? 'bg-brand text-white' : 'bg-panel2 text-muted'"
                    class="px-3 py-1.5 rounded transition"
                >
                    Never
                </button>
                <button
                    @click="customerFilter = 'overdue'; filterCustomers()"
                    :class="customerFilter === 'overdue' ? 'bg-brand text-white' : 'bg-panel2 text-muted'"
                    class="px-3 py-1.5 rounded transition"
                >
                    30+ Days
                </button>
            </div>

            <!-- Customer List -->
            <div
                class="space-y-2 max-h-[500px] overflow-y-auto"
                id="customer-pool"
            >
                <template
                    x-for="customer in filteredCustomers"
                    :key="customer.id"
                >
                    <div
                        class="flex items-center justify-between p-2 rounded-md hover:bg-panel2 transition border border-transparent hover:border-brand/50"
                    >
                        <div class="flex-1">
                            <div
                                class="text-sm font-semibold"
                                x-text="customer.name"
                            ></div>
                            <div
                                class="text-xs text-muted"
                                x-text="customer.city"
                            ></div>
                            <div class="text-xs mt-1">
                                <span class="text-muted">Last: </span>
                                <span
                                    x-text="customer.last_visit || 'Never'"
                                    :class="!customer.last_visit ? 'text-danger' : customer.needs_visit ? 'text-warn' : ''"
                                ></span>
                            </div>
                        </div>
                        <button
                            @click="addToRoute(customer)"
                            class="ml-2 text-xs bg-brand hover:bg-blue-700 text-white px-3 py-1.5 rounded transition"
                        >
                            Add ‚Üí
                        </button>
                    </div>
                </template>
            </div>

            {% if not customers %}
            <div class="text-center py-8">
                <div class="text-3xl mb-2">‚úì</div>
                <div class="text-xs text-muted">
                    All customers are already scheduled!
                </div>
            </div>
            {% endif %}
        </div>

        <!-- RIGHT: Route Builder -->
        <div class="lg:sticky lg:top-4 lg:self-start">
            <div id="route-builder" class="bg-panel rounded-xl shadow-soft p-4">
                <div class="text-center py-8">
                    <div class="text-4xl mb-3">üìç</div>
                    <div class="text-sm font-semibold mb-2">
                        How to Plan a Route
                    </div>
                    <div
                        class="text-xs text-muted space-y-2 text-left max-w-xs mx-auto"
                    >
                        <div class="flex items-start gap-2">
                            <span class="text-brand font-semibold">1.</span>
                            <span
                                >Click a date on the left (or use Quick Add
                                buttons)</span
                            >
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-brand font-semibold">2.</span>
                            <span
                                >Browse available customers in the middle</span
                            >
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-brand font-semibold">3.</span>
                            <span>Click "Add ‚Üí" to add them to your route</span>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-brand font-semibold">4.</span>
                            <span>View your route here and manage stops</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-border">
                        <div class="text-xs text-muted">
                            üí° Tip: Filter customers by "Never" or "30+ Days" to
                            prioritize who needs a visit
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function plannerPage() {
        return {
            query: "",
            selectedDate: null,
            customerFilter: 'all',
            customers: {{ customers_json|safe }},
            filteredCustomers: [],

            init() {
                this.filteredCustomers = this.customers;
            },

            filterCustomers() {
                let filtered = this.customers;

                // Apply search
                if (this.query) {
                    const q = this.query.toLowerCase();
                    filtered = filtered.filter(c =>
                        c.name.toLowerCase().includes(q) ||
                        c.city.toLowerCase().includes(q)
                    );
                }

                // Apply filter
                if (this.customerFilter === 'never') {
                    filtered = filtered.filter(c => !c.last_visit);
                } else if (this.customerFilter === 'overdue') {
                    filtered = filtered.filter(c => c.needs_visit);
                }

                this.filteredCustomers = filtered;
            },

            addToRoute(customer) {
                if (!this.selectedDate) {
                    alert('Please select a date first!');
                    return;
                }

                // Create form data
                const formData = new FormData();
                formData.append('customer_id', customer.id);
                formData.append('route_date', this.selectedDate);

                // Make POST request
                fetch('/planner/add-stop', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(html => {
                    // Update the route builder with the new HTML
                    document.getElementById('route-builder').innerHTML = html;

                    // Show success message
                    this.showToast(`‚úì Added ${customer.name} to route`);

                    // Reload the page after a short delay to update the customer pool
                    setTimeout(() => window.location.reload(), 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to add customer to route. Please try again.');
                });
            },

            showToast(message) {
                // Simple toast notification
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-4 right-4 bg-good text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            }
        };
    }
</script>
{% endblock %}
