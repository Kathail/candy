{% extends "base.html" %}
{% block title %}Balances{% endblock %}
{% block content %}

<div x-data="balancesPage()">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4 md:mb-6">
        <div>
            <h1 class="text-xl md:text-2xl font-semibold">Outstanding Balances</h1>
            <p class="text-xs text-muted mt-1">{{ balances|length }} customer{% if balances|length != 1 %}s{% endif %} with outstanding payments</p>
        </div>
        <a href="{{ url_for('export_payments') }}"
           class="bg-panel2 hover:bg-border text-white text-sm font-semibold px-3 md:px-4 py-2 rounded-md transition flex items-center gap-2 self-start sm:self-auto">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span class="hidden sm:inline">Export Payments</span>
            <span class="sm:hidden">Export</span>
        </a>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mb-4 md:mb-6">
        <div class="bg-panel rounded-lg p-3 md:p-4 shadow-soft">
            <div class="text-xs text-muted mb-1">Total Owed</div>
            <div class="text-xl md:text-2xl font-semibold text-warn">${{ total_owed }}</div>
        </div>
        <div class="bg-panel rounded-lg p-3 md:p-4 shadow-soft">
            <div class="text-xs text-muted mb-1">Customers</div>
            <div class="text-xl md:text-2xl font-semibold">{{ balances|length }}</div>
        </div>
        <div class="bg-panel rounded-lg p-3 md:p-4 shadow-soft">
            <div class="text-xs text-muted mb-1">Average</div>
            <div class="text-xl md:text-2xl font-semibold">${{ avg_balance }}</div>
        </div>
        <div class="bg-panel rounded-lg p-3 md:p-4 shadow-soft">
            <div class="text-xs text-muted mb-1">Highest</div>
            <div class="text-xl md:text-2xl font-semibold text-danger">${{ highest_balance }}</div>
        </div>
    </div>

    <!-- Search and Sort -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-3 mb-4 md:mb-6">
        <input
            type="text"
            name="query"
            placeholder="Search..."
            class="col-span-2 md:col-span-2 bg-panel border border-border rounded-md px-4 py-2 text-sm placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand"
            value="{{ request.args.get('query', '') }}"
            hx-get="/balances"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#balances-list"
            hx-include="[name='sort']"
            hx-swap="innerHTML"
        />

        <select
            name="sort"
            class="bg-panel border border-border rounded-md px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand"
            hx-get="/balances"
            hx-trigger="change"
            hx-target="#balances-list"
            hx-include="[name='query']"
            hx-swap="innerHTML">
            <option value="balance_desc" {% if request.args.get('sort') == 'balance_desc' or not request.args.get('sort') %}selected{% endif %}>Highest Balance</option>
            <option value="balance_asc" {% if request.args.get('sort') == 'balance_asc' %}selected{% endif %}>Lowest Balance</option>
            <option value="name" {% if request.args.get('sort') == 'name' %}selected{% endif %}>Name A-Z</option>
            <option value="visit" {% if request.args.get('sort') == 'visit' %}selected{% endif %}>Oldest Visit</option>
        </select>
    </div>

    <!-- Main Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Balances List -->
        <div class="lg:col-span-2">
            <div id="balances-list" class="space-y-3 scrollable-container">
                {% if balances %}
                    {% for b in balances %}
                    <div
                        class="bg-panel rounded-xl shadow-soft p-4 cursor-pointer hover:ring-2 hover:ring-brand/50 transition"
                        :class="selectedBalance === {{ b.id }} ? 'ring-2 ring-brand' : ''"
                        @click="selectedBalance = {{ b.id }}"
                        hx-get="/balances/{{ b.id }}"
                        hx-target="#balance-details"
                        hx-swap="innerHTML"
                        hx-trigger="click">

                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="text-sm font-semibold">{{ b.name }}</div>
                                <div class="text-xs text-muted mt-0.5">{{ b.city }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-semibold text-warn">${{ "%.2f"|format(b.balance) }}</div>
                                <div class="text-xs text-muted">outstanding</div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between pt-3 border-t border-border">
                            <div class="text-xs">
                                <span class="text-muted">Last Visit: </span>
                                {% if b.last_visit %}
                                    <span>{{ b.last_visit.strftime('%b %d, %Y') }}</span>
                                    {% set days_ago = (now - b.last_visit).days %}
                                    {% if days_ago > 60 %}
                                    <span class="ml-1 bg-danger/20 text-danger px-1.5 py-0.5 rounded">{{ days_ago }}d ago</span>
                                    {% elif days_ago > 30 %}
                                    <span class="ml-1 bg-warn/20 text-warn px-1.5 py-0.5 rounded">{{ days_ago }}d ago</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-danger">Never</span>
                                {% endif %}
                            </div>

                            <div class="flex items-center gap-2">
                                {% if b.phone %}
                                <a href="tel:{{ b.phone }}"
                                   onclick="event.stopPropagation()"
                                   class="text-brand hover:underline text-xs">
                                    ðŸ“ž Call
                                </a>
                                {% endif %}
                                <button
                                    onclick="event.stopPropagation(); openPaymentModal({{ b.id }}, '{{ b.name }}', {{ b.balance }})"
                                    class="bg-good hover:bg-green-600 text-white text-xs font-semibold px-3 py-1 rounded transition">
                                    ðŸ’° Pay
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="bg-panel rounded-xl shadow-soft p-12 text-center">
                        <div class="text-5xl mb-4">âœ“</div>
                        <div class="text-lg font-semibold mb-2">No outstanding balances!</div>
                        <div class="text-sm text-muted">
                            {% if request.args.get('query') %}
                                No customers match your search
                            {% else %}
                                All customers have paid in full
                            {% endif %}
                        </div>
                        {% if request.args.get('query') %}
                        <a href="/balances" class="inline-block text-brand hover:underline text-xs mt-3">Clear search</a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Balance Details Panel -->
        <div class="lg:sticky lg:top-4 lg:self-start">
            <div id="balance-details" class="bg-panel rounded-xl shadow-soft p-4">
                <div class="text-center py-8">
                    <div class="text-5xl mb-4">ðŸ’°</div>
                    <div class="text-lg font-semibold mb-2">Select a customer</div>
                    <div class="text-sm text-muted">Click any customer to view balance details and payment history</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal-wrapper" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div onclick="closePaymentModal()" class="fixed inset-0 bg-black/50"></div>

            <div class="relative bg-panel rounded-xl shadow-2xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Record Payment</h3>
                    <button onclick="closePaymentModal()" class="text-muted hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <form id="payment-form" action="/balances/record-payment" method="POST" class="space-y-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="customer_id" id="payment-customer-id">

                    <div class="bg-panel2 rounded-lg p-4">
                        <div class="text-xs text-muted mb-1">Customer</div>
                        <div class="text-lg font-semibold" id="payment-customer-name"></div>
                        <div class="text-xs text-muted mt-2">Current Balance</div>
                        <div class="text-2xl font-semibold text-warn" id="payment-current-balance"></div>
                    </div>

                    <div>
                        <label class="block text-xs text-muted mb-1">Payment Amount *</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted">$</span>
                            <input type="number"
                                   name="amount"
                                   id="payment-amount"
                                   step="0.01"
                                   min="0.01"
                                   required
                                   class="w-full bg-panel2 border border-border rounded-md pl-8 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand"
                                   placeholder="0.00">
                        </div>
                        <div class="mt-2 flex gap-2">
                            <button type="button" onclick="setPaymentAmount('full')" class="text-xs bg-brand/20 text-brand px-2 py-1 rounded hover:bg-brand/30 transition">
                                Full Amount
                            </button>
                            <button type="button" onclick="setPaymentAmount('half')" class="text-xs bg-panel2 text-muted px-2 py-1 rounded hover:bg-border transition">
                                Half
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs text-muted mb-1">Payment Date</label>
                        <input type="date"
                               name="payment_date"
                               value="{{ now.strftime('%Y-%m-%d') }}"
                               class="w-full bg-panel2 border border-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand">
                    </div>

                    <div>
                        <label class="block text-xs text-muted mb-1">Notes (optional)</label>
                        <textarea name="notes"
                                  rows="2"
                                  class="w-full bg-panel2 border border-border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand"
                                  placeholder="Cash, check, etc..."></textarea>
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button type="submit"
                                class="flex-1 bg-good hover:bg-green-600 text-white text-sm font-semibold px-4 py-2 rounded-md transition">
                            ðŸ’° Record Payment
                        </button>
                        <button type="button"
                                onclick="closePaymentModal()"
                                class="flex-1 bg-panel2 hover:bg-border text-white text-sm font-semibold px-4 py-2 rounded-md transition">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    [x-cloak] { display: none !important; }
</style>

<script>
    let currentBalance = 0;

    function openPaymentModal(customerId, customerName, balance) {
        currentBalance = balance;
        document.getElementById('payment-customer-id').value = customerId;
        document.getElementById('payment-customer-name').textContent = customerName;
        document.getElementById('payment-current-balance').textContent = Utils.formatCurrency(balance);
        document.getElementById('payment-amount').value = balance.toFixed(2);
        Modal.open('payment-modal-wrapper');
    }

    function closePaymentModal() {
        Modal.close('payment-modal-wrapper');
    }

    function setPaymentAmount(type) {
        const amountInput = document.getElementById('payment-amount');
        if (type === 'full') {
            amountInput.value = currentBalance.toFixed(2);
        } else if (type === 'half') {
            amountInput.value = (currentBalance / 2).toFixed(2);
        }
    }

    function balancesPage() {
        return {
            selectedBalance: null
        };
    }
</script>

{% endblock %}
