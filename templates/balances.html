{% extends "base.html" %} {% block title %}Balances{% endblock %} {% block content %}
<div x-data="balancesPage()">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-2xl font-semibold">Outstanding Balances</h1>
            <p class="text-xs text-muted mt-1">{{ balances|length }} customer{% if balances|length != 1 %}s{% endif %} with outstanding payments</p>
        </div>
        <button
            onclick="alert('Bulk payment recording coming soon!')"
            class="bg-brand hover:bg-blue-700 text-white text-xs font-semibold px-4 py-2 rounded-md transition">
            Record Payment
        </button>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="bg-panel rounded-lg p-3 shadow-soft">
            <div class="text-xs text-muted">Total Owed</div>
            <div class="text-xl font-semibold text-warn">${{ total_owed }}</div>
        </div>
        <div class="bg-panel rounded-lg p-3 shadow-soft">
            <div class="text-xs text-muted">Customers</div>
            <div class="text-xl font-semibold">{{ balances|length }}</div>
        </div>
        <div class="bg-panel rounded-lg p-3 shadow-soft">
            <div class="text-xs text-muted">Average</div>
            <div class="text-xl font-semibold">${{ avg_balance }}</div>
        </div>
        <div class="bg-panel rounded-lg p-3 shadow-soft">
            <div class="text-xs text-muted">Highest</div>
            <div class="text-xl font-semibold text-danger">${{ highest_balance }}</div>
        </div>
    </div>

    <!-- Toolbar with Live Search -->
    <form action="/balances" method="get" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
        <input
            type="text"
            name="query"
            placeholder="Search customerâ€¦"
            class="md:col-span-2 bg-panel border border-border rounded-md px-3 py-2 text-sm placeholder:text-muted focus:outline-none focus:ring-1 focus:ring-brand"
            value="{{ request.args.get('query', '') }}"
            hx-get="/balances"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#balances-table"
            hx-include="[name='sort']"
        />

        <select
            name="sort"
            class="bg-panel border border-border rounded-md px-3 py-2 text-sm"
            hx-get="/balances"
            hx-trigger="change"
            hx-target="#balances-table"
            hx-include="[name='query']"
        >
            <option value="balance_desc" {% if request.args.get('sort') == 'balance_desc' or not request.args.get('sort') %}selected{% endif %}>Highest Balance</option>
            <option value="balance_asc" {% if request.args.get('sort') == 'balance_asc' %}selected{% endif %}>Lowest Balance</option>
            <option value="name" {% if request.args.get('sort') == 'name' %}selected{% endif %}>Name A-Z</option>
            <option value="visit" {% if request.args.get('sort') == 'visit' %}selected{% endif %}>Oldest Visit</option>
        </select>
    </form>

    <!-- Main Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Balances Table -->
        <div class="lg:col-span-2" id="balances-table">
            {% if balances %}
            <div class="space-y-3">
                {% for b in balances %}
                <div
                    class="bg-panel rounded-xl shadow-soft p-4 cursor-pointer hover:ring-2 hover:ring-brand/50 transition"
                    :class="selectedBalance === {{ b.id }} ? 'ring-2 ring-brand' : ''"
                    @click="selectedBalance = {{ b.id }}"
                    hx-get="/balances/{{ b.id }}"
                    hx-target="#balance-details"
                    hx-swap="innerHTML"
                    hx-trigger="click"
                >
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <div class="text-sm font-semibold">{{ b.name }}</div>
                            <div class="text-xs text-muted">{{ b.city }}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-semibold text-warn">${{ "%.2f"|format(b.balance) }}</div>
                            <div class="text-xs text-muted">outstanding</div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-3 border-t border-border">
                        <div class="flex items-center gap-4 text-xs">
                            <div>
                                <span class="text-muted">Last Visit: </span>
                                {% if b.last_visit %}
                                    <span>{{ b.last_visit.strftime('%b %d, %Y') }}</span>
                                    {% set days_ago = (now - b.last_visit).days %}
                                    {% if days_ago > 60 %}
                                    <span class="inline-block ml-1 bg-danger/20 text-danger px-1.5 py-0.5 rounded">{{ days_ago }}d ago</span>
                                    {% elif days_ago > 30 %}
                                    <span class="inline-block ml-1 bg-warn/20 text-warn px-1.5 py-0.5 rounded">{{ days_ago }}d ago</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-danger">Never</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            {% if b.phone %}
                            <a href="tel:{{ b.phone }}"
                               onclick="event.stopPropagation()"
                               class="text-brand hover:text-blue-400 transition text-xs flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                Call
                            </a>
                            {% endif %}
                            <button class="text-brand hover:text-blue-400 transition text-xs">
                                View â†’
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="bg-panel rounded-xl shadow-soft p-8 text-center">
                <div class="text-4xl mb-3">âœ“</div>
                <div class="text-sm font-semibold mb-1">No outstanding balances!</div>
                <div class="text-xs text-muted mb-4">
                    {% if request.args.get('query') %}
                        No customers match your search with outstanding balances
                    {% else %}
                        All customers have paid in full
                    {% endif %}
                </div>
                {% if request.args.get('query') %}
                <a href="/balances" class="inline-block text-brand hover:underline text-xs">Clear search</a>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Balance Details Panel -->
        <div class="lg:sticky lg:top-4 lg:self-start">
            <div id="balance-details" class="bg-panel rounded-xl shadow-soft p-4">
                <div class="text-center py-8">
                    <div class="text-4xl mb-3">ðŸ’°</div>
                    <div class="text-sm font-semibold mb-1">Select a customer</div>
                    <div class="text-xs text-muted">Click any customer to view balance details and payment history</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function balancesPage() {
        return {
            selectedBalance: null
        };
    }
</script>
{% endblock %}
