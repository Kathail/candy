<div class="space-y-4">
    <!-- Header -->
    <div class="flex items-start justify-between gap-2">
        <div class="flex-1">
            <h3 class="text-lg font-semibold">{{ stop.customer.name }}</h3>
            <p class="text-sm text-muted">{{ stop.customer.city }}</p>
        </div>
        <div class="flex items-center gap-2">
            {% if stop.completed %}
            <span
                class="flex items-center gap-1 text-good text-xs font-semibold bg-good/10 px-2 py-1 rounded"
            >
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        fill-rule="evenodd"
                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                        clip-rule="evenodd"
                    />
                </svg>
                Done
            </span>
            {% else %}
            <span
                class="text-xs font-semibold bg-warn/20 text-warn px-2 py-1 rounded"
                >Pending</span
            >
            {% endif %}
            <button onclick="closeStopModal()" class="lg:hidden text-muted hover:text-white p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Contact Info -->
    <div class="py-3 border-t border-border space-y-2">
        {% if stop.customer.address %}
        <div>
            <div class="text-xs text-muted mb-1">Address</div>
            <div class="text-sm flex items-center justify-between">
                <span>{{ stop.customer.address }}</span>
                <a
                    href="https://maps.google.com/?q={{ stop.customer.address|urlencode }}"
                    target="_blank"
                    class="text-brand hover:underline text-xs"
                >
                    Navigate â†’
                </a>
            </div>
        </div>
        {% endif %} {% if stop.customer.phone %}
        <div>
            <div class="text-xs text-muted mb-1">Phone</div>
            <div class="text-sm flex items-center justify-between">
                <span>{{ stop.customer.phone }}</span>
                <a
                    href="tel:{{ stop.customer.phone }}"
                    class="text-brand hover:underline text-xs"
                >
                    Call â†’
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Balance -->
    <div class="py-3 border-t border-border">
        <div class="text-xs text-muted mb-1">Customer Balance</div>
        <div
            class="text-2xl font-semibold {% if stop.customer.balance > 0 %}text-warn{% else %}text-good{% endif %}"
        >
            ${{ "%.2f"|format(stop.customer.balance) }}
        </div>
        {% if stop.customer.balance > 0 %}
        <div class="text-xs text-muted mt-1">Outstanding payment due</div>
        {% else %}
        <div class="text-xs text-good mt-1">âœ“ Paid in full</div>
        {% endif %}
    </div>

    <!-- Last Visit -->
    <div class="py-3 border-t border-border">
        <div class="text-xs text-muted mb-1">Last Visit</div>
        <div class="text-sm">
            {% if stop.customer.last_visit %} {{
            stop.customer.last_visit.strftime('%B %d, %Y') }}
            <span class="text-xs text-muted">
                ({{ (stop.route_date - stop.customer.last_visit).days }} days
                ago)
            </span>
            {% else %}
            <span class="text-warn">First time visit</span>
            {% endif %}
        </div>
    </div>

    <!-- Notes -->
    {% if stop.notes or stop.customer.notes %}
    <div class="py-3 border-t border-border">
        <div class="text-xs text-muted mb-2">Notes</div>
        {% if stop.notes %}
        <div class="text-sm bg-panel2 p-2 rounded mb-2">
            <div class="text-xs text-muted mb-1">Stop Notes:</div>
            {{ stop.notes }}
        </div>
        {% endif %} {% if stop.customer.notes %}
        <div class="text-sm bg-panel2 p-2 rounded">
            <div class="text-xs text-muted mb-1">Customer Notes:</div>
            {{ stop.customer.notes }}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Transaction History -->
    {% if stop.customer.payments %}
    <div class="py-3 border-t border-border">
        <div class="text-xs text-muted mb-2">Recent Payments</div>
        <div class="space-y-1 max-h-24 overflow-y-auto">
            {% set sorted_payments = stop.customer.payments|sort(attribute='payment_date', reverse=true) %}
            {% for payment in sorted_payments[:3] %}
            <div class="flex items-center justify-between text-xs bg-panel2 p-2 rounded">
                <span>{{ payment.payment_date.strftime('%b %d, %Y') }}</span>
                <span class="font-semibold text-good">${{ "%.2f"|format(payment.amount) }}</span>
            </div>
            {% endfor %}
            {% if sorted_payments|length > 3 %}
            <div class="text-xs text-muted text-center py-1">+ {{ sorted_payments|length - 3 }} more</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="pt-3 border-t border-border space-y-2">
        {% if not stop.completed %}
        <button
            hx-post="/route/stop/{{ stop.id }}/complete"
            hx-target="#stop-modal-content"
            hx-swap="innerHTML"
            hx-headers='{"X-CSRFToken": "{{ csrf_token() }}"}'
            hx-on::after-request="refreshDesktopPanel({{ stop.id }}); refreshRouteProgress()"
            class="w-full bg-good hover:bg-green-600 text-white text-sm font-semibold px-4 py-3 rounded-md transition flex items-center justify-center gap-2"
        >
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                />
            </svg>
            Mark as Complete
        </button>
        {% else %}
        <button
            hx-post="/route/stop/{{ stop.id }}/uncomplete"
            hx-target="#stop-modal-content"
            hx-swap="innerHTML"
            hx-headers='{"X-CSRFToken": "{{ csrf_token() }}"}'
            hx-on::after-request="refreshDesktopPanel({{ stop.id }}); refreshRouteProgress()"
            class="w-full bg-panel2 hover:bg-border text-white text-sm font-semibold px-4 py-3 rounded-md transition"
        >
            Undo Complete
        </button>
        {% endif %}

        {% if stop.customer.balance > 0 %}
        <!-- Quick Payment Form -->
        <div id="quick-payment-{{ stop.id }}" class="hidden">
            <form hx-post="/route/stop/{{ stop.id }}/payment"
                  hx-target="#stop-modal-content"
                  hx-swap="innerHTML"
                  hx-headers='{"X-CSRFToken": "{{ csrf_token() }}"}'
                  hx-on::after-request="refreshDesktopPanel({{ stop.id }})"
                  class="space-y-2 p-3 bg-panel2 rounded-lg">
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <span class="absolute left-2 top-1/2 -translate-y-1/2 text-muted text-sm">$</span>
                        <input type="number"
                               name="amount"
                               step="0.01"
                               min="0.01"
                               value="{{ "%.2f"|format(stop.customer.balance) }}"
                               required
                               class="w-full bg-panel border border-border rounded-md pl-6 pr-2 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-brand">
                    </div>
                    <button type="submit" class="bg-good hover:bg-green-600 text-white text-sm font-semibold px-3 rounded-md transition">
                        Pay
                    </button>
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="setQuickPayment({{ stop.id }}, {{ stop.customer.balance }})" class="text-xs bg-brand/20 text-brand px-2 py-1 rounded hover:bg-brand/30">Full</button>
                    <button type="button" onclick="setQuickPayment({{ stop.id }}, {{ stop.customer.balance / 2 }})" class="text-xs bg-panel text-muted px-2 py-1 rounded hover:bg-border">Half</button>
                    <button type="button" onclick="toggleQuickPayment({{ stop.id }})" class="text-xs text-muted hover:text-white ml-auto">Cancel</button>
                </div>
            </form>
        </div>
        <button
            id="payment-btn-{{ stop.id }}"
            onclick="toggleQuickPayment({{ stop.id }})"
            class="w-full bg-brand hover:bg-blue-700 text-white text-sm font-semibold px-4 py-3 rounded-md transition"
        >
            ðŸ’° Record Payment (${{ "%.2f"|format(stop.customer.balance) }})
        </button>
        {% endif %}

        <a
            href="/customers/{{ stop.customer.id }}"
            class="block w-full bg-panel2 hover:bg-border text-white text-center text-sm font-semibold px-4 py-3 rounded-md transition"
        >
            View Full Customer Profile
        </a>
    </div>
</div>

<script>
function toggleQuickPayment(stopId) {
    const form = document.getElementById('quick-payment-' + stopId);
    const btn = document.getElementById('payment-btn-' + stopId);
    if (form.classList.contains('hidden')) {
        form.classList.remove('hidden');
        btn.classList.add('hidden');
    } else {
        form.classList.add('hidden');
        btn.classList.remove('hidden');
    }
}

function setQuickPayment(stopId, amount) {
    const form = document.getElementById('quick-payment-' + stopId);
    const input = form.querySelector('input[name="amount"]');
    input.value = amount.toFixed(2);
}
</script>
