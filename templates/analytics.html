{% extends "base.html" %} {% block title %}Analytics{% endblock %} {% block
content %}
<div x-data="analyticsPage()">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-2xl font-semibold">Analytics</h1>
            <p class="text-xs text-muted mt-1">
                Business insights and performance metrics
            </p>
        </div>
        <div class="flex gap-2">
            <div x-data="{ open: false }" class="relative">
                <button @click="open = !open"
                        class="bg-panel2 hover:bg-border text-white text-sm font-semibold px-4 py-2 rounded-md transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div x-show="open" @click.away="open = false"
                     x-cloak
                     class="absolute right-0 mt-2 w-48 bg-panel border border-border rounded-lg shadow-lg z-10">
                    <a href="{{ url_for('export_customers') }}"
                       class="block px-4 py-2 text-sm hover:bg-panel2 rounded-t-lg">
                        Customers CSV
                    </a>
                    <a href="{{ url_for('export_payments') }}"
                       class="block px-4 py-2 text-sm hover:bg-panel2">
                        Payments CSV
                    </a>
                    <a href="{{ url_for('export_routes') }}"
                       class="block px-4 py-2 text-sm hover:bg-panel2 rounded-b-lg">
                        Routes CSV
                    </a>
                </div>
            </div>
            <select
                onchange="window.location.href='/analytics?range=' + this.value"
                class="bg-panel border border-border rounded-md px-3 py-2 text-sm"
            >
                <option value="7" {% if current_range == '7' %}selected{% endif %}>Last 7 Days</option>
                <option value="30" {% if current_range == '30' %}selected{% endif %}>Last 30 Days</option>
                <option value="90" {% if current_range == '90' %}selected{% endif %}>Last 90 Days</option>
                <option value="365" {% if current_range == '365' %}selected{% endif %}>This Year</option>
                <option value="all" {% if current_range == 'all' %}selected{% endif %}>All Time</option>
            </select>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="bg-panel rounded-lg p-4 shadow-soft">
            <div class="flex items-center justify-between mb-2">
                <div class="text-xs text-muted">Total Revenue</div>
                <span class="text-good text-xs">↑ 12%</span>
            </div>
            <div class="text-2xl font-semibold text-good">
                ${{ total_collected }}
            </div>
            <div class="text-xs text-muted mt-1">All payments received</div>
        </div>

        <div class="bg-panel rounded-lg p-4 shadow-soft">
            <div class="flex items-center justify-between mb-2">
                <div class="text-xs text-muted">Outstanding</div>
                <span class="text-warn text-xs"
                    >{{ outstanding_count }} customers</span
                >
            </div>
            <div class="text-2xl font-semibold text-warn">
                ${{ total_outstanding }}
            </div>
            <div class="text-xs text-muted mt-1">Awaiting payment</div>
        </div>

        <div class="bg-panel rounded-lg p-4 shadow-soft">
            <div class="flex items-center justify-between mb-2">
                <div class="text-xs text-muted">Avg per Stop</div>
                <span class="text-brand text-xs">{{ total_stops }} stops</span>
            </div>
            <div class="text-2xl font-semibold">${{ avg_per_stop }}</div>
            <div class="text-xs text-muted mt-1">Revenue efficiency</div>
        </div>

        <div class="bg-panel rounded-lg p-4 shadow-soft">
            <div class="flex items-center justify-between mb-2">
                <div class="text-xs text-muted">Visit Rate</div>
                <span class="text-good text-xs">↑ 8%</span>
            </div>
            <div class="text-2xl font-semibold">{{ visit_rate }}%</div>
            <div class="text-xs text-muted mt-1">Completed stops</div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <!-- Revenue Over Time -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="flex items-center justify-between mb-4">
                <div class="text-sm font-semibold">Revenue Trend</div>
                <div class="text-xs text-good">↑ Trending up</div>
            </div>
            <div class="h-64">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Customer Distribution -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="flex items-center justify-between mb-4">
                <div class="text-sm font-semibold">Customer Status</div>
                <div class="text-xs text-muted">
                    {{ total_customers }} total
                </div>
            </div>
            <div class="h-64 flex items-center justify-center">
                <canvas id="customerChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <!-- Top Customers -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="flex items-center justify-between mb-3">
                <div class="text-sm font-semibold">Top Customers</div>
                <div class="text-xs text-muted">By revenue</div>
            </div>
            <div class="space-y-2">
                {% for customer in top_customers[:5] %}
                <div
                    class="flex items-center justify-between p-2 bg-panel2 rounded"
                >
                    <div>
                        <div class="text-sm font-semibold">
                            {{ customer.name }}
                        </div>
                        <div class="text-xs text-muted">
                            {{ customer.payment_count }} payments
                        </div>
                    </div>
                    <div class="text-sm font-semibold text-good">
                        ${{ "%.2f"|format(customer.total_paid) }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="flex items-center justify-between mb-3">
                <div class="text-sm font-semibold">Recent Activity</div>
                <div class="text-xs text-muted">Last 7 days</div>
            </div>
            <div class="space-y-3">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-full bg-good/20 flex items-center justify-center"
                    >
                        <span class="text-good font-semibold"
                            >{{ completed_this_week }}</span
                        >
                    </div>
                    <div>
                        <div class="text-sm font-semibold">Stops Completed</div>
                        <div class="text-xs text-muted">This week</div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-full bg-brand/20 flex items-center justify-center"
                    >
                        <span class="text-brand font-semibold"
                            >{{ payments_this_week }}</span
                        >
                    </div>
                    <div>
                        <div class="text-sm font-semibold">
                            Payments Received
                        </div>
                        <div class="text-xs text-muted">This week</div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-full bg-warn/20 flex items-center justify-center"
                    >
                        <span class="text-warn font-semibold"
                            >{{ new_customers }}</span
                        >
                    </div>
                    <div>
                        <div class="text-sm font-semibold">New Customers</div>
                        <div class="text-xs text-muted">This month</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- City Breakdown -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="flex items-center justify-between mb-3">
                <div class="text-sm font-semibold">By Location</div>
                <div class="text-xs text-muted">{{ cities|length }} cities</div>
            </div>
            <div class="space-y-2">
                {% for city in cities[:5] %}
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="text-sm">{{ city.name }}</div>
                        <div class="w-full bg-panel2 rounded-full h-1.5 mt-1">
                            <div
                                class="bg-brand h-1.5 rounded-full"
                                style="width: {{ (city.count / total_customers * 100)|int }}%"
                            ></div>
                        </div>
                    </div>
                    <div class="text-sm font-semibold ml-3">
                        {{ city.count }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Detailed Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Payment Analysis -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="text-sm font-semibold mb-3">Payment Analysis</div>
            <div class="space-y-3">
                <div
                    class="flex items-center justify-between py-2 border-b border-border"
                >
                    <span class="text-sm text-muted">Total Payments</span>
                    <span class="text-sm font-semibold"
                        >{{ total_payments }}</span
                    >
                </div>
                <div
                    class="flex items-center justify-between py-2 border-b border-border"
                >
                    <span class="text-sm text-muted">Average Payment</span>
                    <span class="text-sm font-semibold text-good"
                        >${{ avg_payment }}</span
                    >
                </div>
                <div
                    class="flex items-center justify-between py-2 border-b border-border"
                >
                    <span class="text-sm text-muted">Largest Payment</span>
                    <span class="text-sm font-semibold text-brand"
                        >${{ largest_payment }}</span
                    >
                </div>
                <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-muted">Collection Rate</span>
                    <span class="text-sm font-semibold text-good"
                        >{{ collection_rate }}%</span
                    >
                </div>
            </div>
        </div>

        <!-- Route Efficiency -->
        <div class="bg-panel rounded-xl shadow-soft p-4">
            <div class="text-sm font-semibold mb-3">Route Efficiency</div>
            <div class="space-y-3">
                <div
                    class="flex items-center justify-between py-2 border-b border-border"
                >
                    <span class="text-sm text-muted">Total Routes</span>
                    <span class="text-sm font-semibold"
                        >{{ total_routes }}</span
                    >
                </div>
                <div
                    class="flex items-center justify-between py-2 border-b border-border"
                >
                    <span class="text-sm text-muted">Avg Stops per Route</span>
                    <span class="text-sm font-semibold"
                        >{{ avg_stops_per_route }}</span
                    >
                </div>
                <div
                    class="flex items-center justify-between py-2 border-b border-border"
                >
                    <span class="text-sm text-muted">Completion Rate</span>
                    <span class="text-sm font-semibold text-good"
                        >{{ completion_rate }}%</span
                    >
                </div>
                <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-muted">Busiest Day</span>
                    <span class="text-sm font-semibold">{{ busiest_day }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    function analyticsPage() {
        return {
            init() {
                // Revenue Chart
                const revenueCtx = document.getElementById('revenueChart');
                if (revenueCtx) {
                    new Chart(revenueCtx, {
                        type: 'line',
                        data: {
                            labels: {{ revenue_labels|safe }},
                            datasets: [{
                                label: 'Revenue',
                                data: {{ revenue_data|safe }},
                                borderColor: '#22c55e',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { color: '#94a3b8' }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: '#94a3b8' }
                                }
                            }
                        }
                    });
                }

                // Customer Distribution Chart
                const customerCtx = document.getElementById('customerChart');
                if (customerCtx) {
                    new Chart(customerCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Paid Up', 'Outstanding', 'Never Visited'],
                            datasets: [{
                                data: {{ customer_distribution|safe }},
                                backgroundColor: ['#22c55e', '#facc15', '#ef4444'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: '#94a3b8', padding: 15 }
                                }
                            }
                        }
                    });
                }
            }
        };
    }
</script>
{% endblock %}
